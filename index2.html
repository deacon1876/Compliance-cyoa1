<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Compliance Adventure — CYOA</title>
<style>
  :root{ --hdr:56px; }

  /* Base */
  body {
    margin:0;background:#0b1020;color:#e5e7eb;
    font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;
    overflow:hidden;
  }
  .hidden{display:none}

  /* Header */
  header{position:sticky;top:0;background:rgba(2,6,23,.75);backdrop-filter:blur(8px);border-bottom:1px solid rgba(148,163,184,.25);z-index:5}
  .wrap{max-width:1080px;margin:0 auto;padding:0 18px;height:var(--hdr);display:flex;justify-content:space-between;align-items:center}
  .title{font-weight:800}
  .pill{border:1px solid rgba(148,163,184,.35);border-radius:999px;padding:.25rem .7rem;color:#94a3b8}

  /* Screen uses full viewport under header */
  .screen{height:calc(100vh - var(--hdr));padding:0}

  /* Stage layout */
  .stage{height:100%;max-width:1400px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:0}

  /* Left panel */
  .pane,.result,.summary,.final{height:100%;overflow:auto;background:rgba(17,24,39,.6);border:1px solid #1f2937;border-radius:0;padding:18px}
  @media (min-width:901px){
    .pane,.result,.summary,.final{border-radius:16px 0 0 16px}
    .mediaBox{border-radius:0 16px 16px 0}
  }

  .scene-meta{color:#94a3b8;margin-bottom:6px}
  .choices{display:grid;gap:12px;margin-top:14px}
  button.choice{appearance:none;background:rgba(255,255,255,.06);color:#e5e7eb;padding:14px;border-radius:12px;text-align:left;font-weight:700;cursor:pointer;transition:.15s ease;border:3px solid transparent}
  button.choice:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,.25)}
  button.choice:focus{outline:3px solid #60a5fa;outline-offset:2px}

  .c1{border-color:#60a5fa}      .c1:hover{background:rgba(96,165,250,.12)}
  .c2{border-color:#34d399}      .c2:hover{background:rgba(52,211,153,.12)}
  .c3{border-color:#f59e0b}      .c3:hover{background:rgba(245,158,11,.12)}
  .c4{border-color:#a78bfa}      .c4:hover{background:rgba(167,139,250,.12)}
  .c5{border-color:#fb7185}      .c5:hover{background:rgba(251,113,133,.12)}
  .c6{border-color:#22d3ee}      .c6:hover{background:rgba(34,211,238,.12)}

  .mediaBox{height:100%;overflow:hidden;background:#0a0f1d;border:1px solid #1f2937}
  .mediaBox img{width:100%;height:100%;object-fit:cover;display:block}

  .good{color:#22c55e;font-weight:800}
  .bad{color:#f87171;font-weight:800}
  .warn{color:#94a3b8;margin:.5rem 0 0 1rem}

  #resultWarn, #finalList { list-style-type:none; padding-left:0; margin-left:0; }

  .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px}
  .btn{background:linear-gradient(90deg,#60a5fa,#3b82f6);color:#fff;border:0;padding:.8rem 1rem;border-radius:10px;font-weight:800;cursor:pointer}
  .ghost{background:transparent;color:#e5e7eb;border:1px solid rgba(148,163,184,.45);padding:.8rem 1rem;border-radius:10px;font-weight:700;cursor:pointer}

  /* Final list rows */
  .row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px 10px;border:1px solid rgba(148,163,184,.25);border-radius:10px;margin-bottom:8px;background:rgba(255,255,255,.04)}
  .tag{font-size:12px;color:#94a3b8}
  .badge{font-weight:800}
  .badge.good{color:#22c55e}
  .badge.bad{color:#f87171}

  /* Home icon button */
  .homebtn{display:inline-flex;align-items:center;gap:8px}
  .homebtn svg{width:18px;height:18px}

  /* Responsive (mobile) */
  @media (max-width:900px){
    .stage{grid-template-columns:1fr;grid-template-rows:55vh 45vh}
    .mediaBox{grid-row:2/3;border-radius:0}
    .pane,.result,.summary,.final{grid-row:1/2;border-radius:0}

    body, h1, h2, h3, h4, h5, h6,
    p, span, div, button, input, select, textarea { font-size:12px; }
    h2{font-size:13px}
    h3{font-size:14px}
  }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="title">컴플라이언스 이벤트</div>
    <div>
      <button class="ghost homebtn" onclick="go('menuScreen')" type="button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M3 11l9-8 9 8"/><path d="M9 22V12h6v10"/></svg>
        메인
      </button>
      <span class="pill" id="crumb">플레이어: 플레이어</span>
    </div>
  </div>
</header>

<!-- Start -->
<section class="screen" id="startScreen">
  <div class="stage">
    <div class="pane" style="padding-top:22px;max-width:800px">
      <h2>시작하기</h2>
      <p>플레이어 이름을 입력하세요. 입력하지 않으면 “플레이어”로 진행됩니다.</p>
      <input id="playerNameInput" type="text" placeholder="예: 홍길동 / Alex" style="width:90%;padding:12px 14px;border-radius:10px;border:1px solid rgba(148,163,184,.35);background:#0f172a;color:#e5e7eb;outline:none">
      <div class="nav" style="justify-content:space-between">
        <span style="color:#94a3b8">이름은 메뉴에서 변경할 수 있습니다.</span>
        <button class="btn" onclick="startGame()" type="button">게임 시작</button>
      </div>
    </div>
    <div class="mediaBox"><img src="cover.png" alt="게임 표지"></div>
  </div>
</section>

<!-- Menu -->
<section class="screen hidden" id="menuScreen">
  <div class="stage">
    <div class="pane" style="padding-top:22px;max-width:800px">
      <h2>3개 에피소드 코스</h2>
      <p><span class="pname">플레이어</span>님, 시작하면 3개 에피소드가 순차 진행됩니다.</p>

      <!-- course description -->
      <div class="courseDesc" style="margin:12px 0 16px;padding:12px 14px;border:1px solid rgba(148,163,184,.35);border-radius:10px;background:rgba(255,255,255,.04);color:#cbd5e1;">
        <h3 style="margin:0 0 6px 0;font-size:1rem">코스 소개</h3>
        <p style="margin:0">이 코스는 실제 업무 상황을 바탕으로 다음 세 주제를 다룹니다.</p>
        <ul style="margin:8px 0 0 18px">
          <li>에피소드 1 — 직장 내 괴롭힘 대응</li>
          <li>에피소드 2 — Integrity</li>
          <li>에피소드 3 — 공정거래</li>
        </ul>
      </div>

      <div id="episodeButtons" class="fullgrid">
        <button class="btn" onclick="startCourse()" type="button">코스 시작</button>
        <button class="ghost" onclick="changeName()" type="button">플레이어 이름 변경하기</button>
        <button class="ghost" onclick="resetCourse()" type="button">초기화</button>
      </div>
    </div>
    <div class="mediaBox"><img src="menu_banner.png" alt="메인 메뉴"></div>
  </div>
</section>

<!-- Situation -->
<section class="screen hidden" id="situationScreen">
  <div class="stage">
    <div class="pane">
      <div class="scene-meta" id="sceneMeta"></div>
      <h2 id="episodeTitle"></h2>
      <p id="situationText"></p>
      <div id="choices" class="choices"></div>
    </div>
    <div class="mediaBox" id="situationMediaRight" aria-live="polite"></div>
  </div>
</section>

<!-- Result (per-situation) -->
<section class="screen hidden" id="resultScreen">
  <div class="stage">
    <div class="result">
      <h3 id="resultTitle"></h3>
      <p id="resultText"></p>
      <ul class="warn" id="resultWarn"></ul>
      <div class="nav">
        <button class="ghost" onclick="go('menuScreen')" type="button">메인 메뉴</button>
        <button class="btn" id="nextButton" type="button">다음</button>
      </div>
    </div>
    <div class="mediaBox" id="resultMediaRight" aria-live="polite"></div>
  </div>
</section>

<!-- Final Results -->
<section class="screen hidden" id="finalResultsScreen">
  <div class="stage">
    <div class="final">
      <h3>최종 결과</h3>
      <p id="scoreLine"></p>
      <div id="finalList"></div>
      <div class="nav" style="justify-content:space-between">
        <button class="ghost homebtn" onclick="go('menuScreen')" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M3 11l9-8 9 8"/><path d="M9 22V12h6v10"/></svg>
          메인으로
        </button>
        <button class="btn" onclick="startCourse()" type="button">다시 시작</button>
      </div>
    </div>
    <div class="mediaBox" id="finalMediaRight"><img src="ep3_summary.png" alt="결과 요약"></div>
  </div>
</section>

<script>
  // ---------- State ----------
  let playerName = '플레이어';
  let currentEpisode = 0;
  let currentSituation = 0;

  // Tracking answers for final results
  const answers = [];
  let correctCount = 0;
  let totalQuestions = 0;

  // ---------- Data (3 episodes only) ----------
  const episodes = [
  // EPISODE 1: 직장 내 괴롭힘 대응
  {
    title: "에피소드 1: 직장 내 괴롭힘 대응",
    summaryMedia: "ep3_summary.png",
    situations: [
      {
        meta: "에피소드 1 · 상황 1-1",
        media: "situation_ep3_1.png",
        text: "선배가 신입에게 욕설을 퍼붓는다. 모두가 시선을 피한다. {{name}}는 어떻게 해야 하는가?",
        choices: [
          { text:"명백한 괴롭힘이므로 즉시 중단을 요구하고, 필요시 보고한다.",
            correct:true,
            feedback:{
              title:"좋은 선택",
              body:"근로기준법 제76조의2는 직장 내 괴롭힘을 금지합니다. 윤리적으로도 방관하는 것은 피해자를 외면하는 것입니다."
            }
          },
          { text:"침묵한다.",
            correct:false,
            feedback:{
              title:"잘못된 선택",
              body:"괴롭힘을 방관하는 것은 직장 내 괴롭힘을 금지하는 제76조의2의 취지에 반합니다. 윤리적으로도 침묵은 동조로 비칠 수 있습니다."
            }
          }
        ]
      },
      {
        meta: "에피소드 1 · 상황 1-2",
        media: "situation_ep3_2.png",
        text: "직장내 괴롭힘을 목격했는데, 내 부서 사람들이 아니다. {{name}} 생각으로는 내가 이를 회사에 보고할 자격이 있나?",
        choices: [
          { text:"보고할 수 있다. 누구든지 신고할 수 있고 사용자는 지체 없이 객관적으로 조사해야 한다.",
            correct:true,
            feedback:{
              title:"좋은 선택",
              body:"근로기준법 제76조의3에 따르면 누구든지 직장 내 괴롭힘 사실을 알게 되면 사용자에게 신고할 수 있으며, 사용자는 이에 대해 지체 없이 객관적으로 조사해야 합니다. <br>윤리적으로도 동료의 고통을 외면하지 않아야 합니다."
            }
          },
          { text:"어차피 바뀌는 것도 없을 텐데 관여하지 말자.",
            correct:false,
            feedback:{
              title:"잘못된 선택",
              body:"근로기준법 제76조의3에 따르면 누구든지 직장 내 괴롭힘 사실을 알게 되면 사용자에게 신고할 수 있으며, 사용자는 이에 대해 지체 없이 객관적으로 조사해야 합니다. <br>괴롭힘을 외면하면 것은 윤리적으로도 타인의 고통을 방관하는 것입니다."
            }
          }
        ]
      },
      {
        meta: "에피소드 1 · 상황 1-3",
        media: "situation_ep3_3.png",
        text: "단체 채팅방에서 특정 직원을 조롱하는 메시지가 이어진다. 온라인 조롱 역시 괴롭힘으로 간주될 수 있다. {{name}}는 어떻게 하겠는가?",
        choices: [
          { text:"중단을 요구하고 신고·상담 경로를 안내한다.",
            correct:true,
            feedback:{
              title:"좋은 선택",
              body:"단체 채팅방에서 특정 직원을 흉보는 행위는 근로기준법 제76조의2 직장 내 괴롭힘에 해당할 수 있으며, 설사 법적 처벌로 이어지지 않더라도 윤리적·조직문화 차원에서 중대한 위반입니다. <br>윤리적으로도 불편함을 감수하고도 윤리적으로도 옳은 행동을 하는 것이 맞습니다."
            }
          },
          { text:"괜히 나섰다가 불편해질까봐 침묵한다.",
            correct:false,
            feedback:{
              title:"잘못된 선택",
              body:"단체 채팅방에서 특정 직원을 흉보는 행위는 근로기준법 제76조의2 직장 내 괴롭힘에 해당할 수 있으며, 설사 법적 처벌로 이어지지 않더라도 윤리적·조직문화 차원에서 중대한 위반입니다. <br>또한 윤리적으로도 불편함을 감수하고도 윤리적으로도 옳은 행동을 하는 것이 맞습니다."
            }
          }
        ]
      }
    ]
  },

  // EPISODE 2: Integrity (선물·접대)
  {
    title: "에피소드 2: Integrity",
    summaryMedia: "ep2_summary.png",
    situations: [
      {
        meta: "에피소드 2 · 상황 2-1",
        media: "situation_ep2_1.png",
        text: "협력업체가 자기들이 준비한 공식적인 행사라면서 고급 레스토랑으로 초대한다. {{name}}는 어떻게 하겠는가?",
        choices: [
          { text:"회사 규정·부패방지정책을 근거로 정중히 거절한다.",
            correct:true,
            feedback:{
              title:"좋은 선택",
              body:"「독점규제 및 공정거래에 관한 법률」 제23조 제1항 제1호(부당한 고객유인행위 금지)에 따라 협력업체가 거래처를 고급 레스토랑으로 초대하는 것이 정상적인 업무 목적을 넘어선 과도한 접대라면, “부당한 고객유인행위”로 판단될 수 있습니다. <br>또한, 사내 규정 위반일 수 있습니다."
            }
          },
          { text:"공식 자리로 포장되었으니 참석한다.",
            correct:false,
            feedback:{
              title:"잘못된 선택",
              body:"「독점규제 및 공정거래에 관한 법률」 제23조 제1항 제1호(부당한 고객유인행위 금지)에 따라 협력업체가 거래처를 고급 레스토랑으로 초대하는 것이 정상적인 업무 목적을 넘어선 과도한 접대라면, “부당한 고객유인행위”로 판단될 수 있습니다. <br>또한, 사내 규정 위반일 수 있습니다."
            }
          }
        ]
      },
      {
        meta: "에피소드 2 · 상황 2-2",
        media: "situation_ep2_2.png",
        text: "거래처가 비싼 선물을 내민다. 회사 규정 위반일 뿐 아니라 상법상 업무상 배임 위험이 있다.",
        choices: [
          { text:"받을 수 없음을 설명하고 거절한다.",
            correct:true,
            feedback:{
              title:"좋은 선택",
              body:"규정 위반 위험이 있고, 불필요한 오해가 발생할 수 있습니다. "
            }
          },
          { text:"일단 받고 나중에 생각한다.",
            correct:false,
            feedback:{
              title:"잘못된 선택",
              body:"규정 위반 위험이 있고, 불필요한 오해가 발생할 수 있습니다. "
            }
          }
        ]
      },
      {
        meta: "에피소드 2 · 상황 2-3",
        media: "situation_ep2_3.png",
        text: "동료가 말한다. “뭐 어때? 이 정도 선물은 다 받아.” 내가 너무 민감한 걸까? {{name}}는 어떻게 하겠는가?",
        choices: [
          { text:"작아도 누적되면 문제, 원칙을 지킨다.",
            correct:true,
            feedback:{
              title:"좋은 선택",
              body:"관행보다 원칙을 따르는 것이 Integrity입니다. 작은 편법이 쌓이면 결국 큰 신뢰 손실로 이어집니다."
            }
          },
          { text:"분위기를 깨지 않으려 맞장구친다.",
            correct:false,
            feedback:{
              title:"잘못된 선택",
              body:"이는 조직문화를 망치는 행동입니다. 작은 편법이 쌓이면 결국 큰 신뢰 손실로 이어집니다."
            }
          }
        ]
      }
    ]
  },

  // EPISODE 3: 공정거래
  {
    title: "에피소드 3: 공정거래",
    summaryMedia: "ep1_summary.png",
    situations: [
      {
        meta: "에피소드 3 · 상황 3-1",
        media: "situation_ep1_1.png",
        text: "협력업체 담당자가 부탁한다. “이번 입찰에서 꼭 우리 회사가 되게 도와주세요.” 이는 공정거래법상 입찰방해 행위로 제재 대상이다. {{name}}는 어떻게 하겠는가?",
        choices: [
          { text: "공고문·평가기준 외 영향은 불가하다고 설명한다.",
            correct: true,
            feedback: {
              title:"좋은 선택",
              body:"협력업체와 결과를 합의하게 되면 입찰담합·입찰방해 행위에 해당됩니다.<br><br>「독점규제 및 공정거래에 관한 법률」("공정거래법") 제19조 제1항 제8호 (부당한 공동행위)<br>- “입찰 또는 경매에 있어서 경쟁을 실질적으로 제한하는 행위”를 금지.<br>- 입찰담합 같은 경우가 전형적으로 여기에 해당.<br>- 사업자들이 서로 짜고 낙찰자를 정하거나 경쟁을 방해하는 행위는 바로 이 조항으로 제재."
            }
          },
          { text: "심사위원 취향을 살짝 귀띔해 준다.",
            correct: false,
            feedback: {
              title:"잘못된 선택",
              body:"입찰에서 특정업체에게 유리한 행동을 하면 입찰담합·입찰방해 행위에 해당됩니다.<br><br>「독점규제 및 공정거래에 관한 법률」("공정거래법") 제19조 제1항 제8호 (부당한 공동행위)<br>- “입찰 또는 경매에 있어서 경쟁을 실질적으로 제한하는 행위”를 금지.<br>- 입찰담합 같은 경우가 전형적으로 여기에 해당.<br>- 사업자들이 서로 짜고 낙찰자를 정하거나 경쟁을 방해하는 행위는 바로 이 조항으로 제재."
            }
          }
        ]
      },
      {
        meta: "에피소드 3 · 상황 3-2",
        media: "situation_ep1_2.png",
        text: "상사가 말한다. “이번 입찰에서는 ○○업체 밀어주자.” {{name}}는 어떻게 하겠는가?",
        choices: [
          { text: "평가기준·절차 준수를 근거로 공정 평가를 제안한다.",
            correct: true,
            feedback:{ 
              title:"좋은 선택", 
              body:"부당한 지시를 거절하고 절차를 따랐습니다. 「독점규제 및 공정거래에 관한 법률」("공정거래법")상 부당 지원행위 (제23조 제1항 제7호) 및 소속 기업에 재산상 손해를 입힐 가능성이 있어 「형법」상 업무상 배임죄 (제356조)에 해당할 수 있습니다. "
            }
          },
          { text: "일단 상사 뜻을 따른다.",
            correct:false,
            feedback:{ 
              title:"잘못된 선택", 
              body:"이는 공정거래법 취지에 반합니다. 「독점규제 및 공정거래에 관한 법률」("공정거래법")상 부당 지원행위 (제23조 제1항 제7호) 및 소속 기업에 재산상 손해를 입힐 가능성이 있어 「형법」상 업무상 배임죄 (제356조)에 해당할 수 있습니다. "
            }
          }
        ]
      },
      {
        meta: "에피소드 3 · 상황 3-3",
        media: "situation_ep1_3.png",
        text: "어느 회사에 대한 중요한 미공개 내부정보를 알게 되었는데 곧 그 회사 주가에 큰 변동이 있을 것 같다. {{name}}는 어떻게 하겠는가?",
        choices: [
          { text: "내부정보는 절대 사용하지 않는다.",
            correct: true,
            feedback:{ 
              title:"좋은 선택", 
              body:"자본시장법 제174조는 미공개 중요정보 이용행위를 금지하는 규정입니다. 이는 투자자의 투자 판단에 중대한 영향을 미칠 수 있는 정보를 불특정 다수인이 알 수 있도록 공개되기 전에 해당 정보를 이용하여 주식 등을 매매하거나 그 정보로 이익을 얻는 행위를 막기 위한 것입니다."
            }
          },
          { text: "소액의 이익만 남기면 괜찮을테니 그 회사의 주식을 거래한다.",
            correct:false,
            feedback:{ 
              title:"잘못된 선택", 
              body:"자본시장법 제174조는 미공개 중요정보 이용행위를 금지하는 규정입니다. 이는 투자자의 투자 판단에 중대한 영향을 미칠 수 있는 정보를 불특정 다수인이 알 수 있도록 공개되기 전에 해당 정보를 이용하여 주식 등을 매매하거나 그 정보로 이익을 얻는 행위를 막기 위한 것입니다. 이는 시장의 신뢰를 해치는 비윤리적 행동입니다."
            }
          }
        ]
      }
    ]
  }
];

  // ---------- Helpers ----------
  const $ = sel => document.querySelector(sel);
  const colorClasses = ['c1','c2','c3','c4','c5','c6'];

  function go(id){
    document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
    $('#'+id).classList.remove('hidden');
    window.scrollTo({top:0,behavior:'instant'});
    renderNames();
  }
  function renderNames(){
    document.querySelectorAll('.pname').forEach(el=>el.textContent=playerName);
    $('#crumb').textContent = `플레이어: ${playerName}`;
  }

  function startGame(){
    const v = ($('#playerNameInput').value||'').trim();
    playerName = v || '플레이어';
    go('menuScreen');
  }
  function changeName(){
    const v = prompt('새 플레이어 이름을 입력하세요', playerName);
    if (v!==null){
      const nv = v.trim();
      if (nv) playerName = nv;
      renderNames();
    }
  }
  function resetCourse(){
    currentEpisode = 0; currentSituation = 0;
    answers.length = 0; correctCount = 0;
    go('menuScreen');
  }
  function startCourse(){
    // reset progress & counters
    currentEpisode = 0; currentSituation = 0;
    answers.length = 0; correctCount = 0;
    totalQuestions = episodes.reduce((n,ep)=>n + ep.situations.length, 0);
    showSituation();
  }

  function renderMediaInto(sel, src, alt){
    const box = $(sel);
    box.innerHTML = '';
    if (!src) return;
    const img = document.createElement('img');
    img.src = src; img.alt = alt || '이미지';
    box.appendChild(img);
  }

  function showSituation(){
    const ep = episodes[currentEpisode];
    const sit = ep.situations[currentSituation];
    go('situationScreen');

    renderMediaInto('#situationMediaRight', sit.media, sit.meta);
    $('#sceneMeta').textContent = sit.meta || '';
    $('#episodeTitle').textContent = ep.title + ' — 상황 ' + (currentSituation+1);
    $('#situationText').textContent = (sit.text||'').replaceAll('{{name}}', playerName);

    // choices randomized
    const shuffled = [...sit.choices].sort(()=>Math.random()-0.5);
    const bowl = $('#choices'); bowl.innerHTML = '';
    shuffled.forEach((choice, idx) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'choice ' + colorClasses[idx % colorClasses.length];
      btn.textContent = choice.text;
      btn.onclick = () => showResult(choice);
      btn.setAttribute('aria-label', (choice.correct?'정답 가능성 있음: ':'선택: ')+choice.text);
      bowl.appendChild(btn);
    });

    const first = bowl.querySelector('button.choice'); if (first) first.focus();
    bowl.onkeydown = (e)=>{
      const buttons = [...bowl.querySelectorAll('button.choice')];
      const i = buttons.indexOf(document.activeElement);
      if (e.key === 'ArrowDown' || e.key === 'ArrowRight'){ e.preventDefault(); buttons[(i+1+buttons.length)%buttons.length]?.focus(); }
      if (e.key === 'ArrowUp' || e.key === 'ArrowLeft'){ e.preventDefault(); buttons[(i-1+buttons.length)%buttons.length]?.focus(); }
      if (e.key === 'Enter' && document.activeElement?.classList.contains('choice')){ document.activeElement.click(); }
    };
  }

  function showResult(choice){
    go('resultScreen');

    const good = !!choice.correct;
    if (good) correctCount++;

    // record for final results
    const ep = episodes[currentEpisode];
    const sit = ep.situations[currentSituation];
    answers.push({
      epIndex: currentEpisode,
      epTitle: ep.title,
      meta: sit.meta,
      question: sit.text.replaceAll('{{name}}', playerName),
      picked: choice.text,
      correct: good
    });

    // UI
    $('#resultTitle').className = good ? 'good' : 'bad';
    $('#resultTitle').textContent = choice.feedback?.title || (good ? '좋은 선택' : '잘못된 선택');
    $('#resultText').textContent = choice.feedback?.body || (good ? '바람직한 판단입니다.' : '다시 생각해 보세요.');

    // result image
    const GOOD_MEDIA = ["good_choice.png","good_choice_alt1.png","good_choice_alt2.png"];
    const BAD_MEDIA  = ["bad_choice.png","bad_choice_alt1.png","bad_choice_alt2.png"];
    const pick = arr => arr[Math.floor(Math.random() * arr.length)];
    const resultSrc = choice.resultMedia || (good ? pick(GOOD_MEDIA) : pick(BAD_MEDIA));
    renderMediaInto('#resultMediaRight', resultSrc, good ? '좋은 선택' : '나쁜 선택');

    // warnings
    const warn = choice.feedback?.warn || [];
    const ul = $('#resultWarn'); ul.innerHTML = '';
    warn.forEach(w => { const li=document.createElement('li'); li.textContent=w; ul.appendChild(li); });

    // next
    const nextBtn = $('#nextButton');
    const isLastSituation = currentSituation >= ep.situations.length - 1;
    const isLastEpisode = currentEpisode >= episodes.length - 1;

    nextBtn.onclick = () => {
      if (!isLastSituation){
        currentSituation++; showSituation();
      } else if (!isLastEpisode){
        currentEpisode++; currentSituation = 0; showSituation();
      } else {
        showFinalResults();
      }
    };
    nextBtn.textContent = (!isLastSituation) ? '다음 상황으로' : (!isLastEpisode ? '다음 에피소드로' : '최종 결과 보기');
  }

  function showFinalResults(){
    go('finalResultsScreen');

    // Score line
    $('#scoreLine').textContent = `${playerName}님의 점수: ${correctCount} / ${totalQuestions}`;

    // List
    const box = $('#finalList'); box.innerHTML = '';
    answers.forEach((a, idx) => {
      const row = document.createElement('div');
      row.className = 'row';
      const idxSpan = document.createElement('div');
      idxSpan.textContent = `${idx+1}.`;
      const textDiv = document.createElement('div');
      const t1 = document.createElement('div');
      t1.innerHTML = `<span class="tag">${episodes[a.epIndex].title}</span>`;
      const t2 = document.createElement('div');
      t2.textContent = a.meta || '';
      const t3 = document.createElement('div');
      t3.textContent = `선택: ${a.picked}`;
      textDiv.appendChild(t1); textDiv.appendChild(t2); textDiv.appendChild(t3);

      const badge = document.createElement('div');
      badge.className = 'badge ' + (a.correct ? 'good' : 'bad');
      badge.textContent = a.correct ? '정답' : '오답';

      row.appendChild(idxSpan); row.appendChild(textDiv); row.appendChild(badge);
      box.appendChild(row);
    });

    // Right media (use last episode summary by default)
    const lastSum = episodes[episodes.length-1].summaryMedia || 'ep3_summary.png';
    renderMediaInto('#finalMediaRight', lastSum, '결과 요약');
  }

  // Initial render
  (function init(){ renderNames(); })();
</script>
</body>
</html>
